{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aims.dev/schemas/deploy-security-packet.json",
  "title": "Deploy Security Packet (DSP)",
  "version": "1.0.0",
  "description": "The legal contract for what can happen during a Shift - drives all security enforcement",

  "type": "object",
  "required": ["packetId", "shiftId", "createdAt", "identityAccess", "network", "secretsData", "supplyChain", "runtimeHardening", "detectionResponse", "auditEvidence"],

  "properties": {
    "packetId": {
      "type": "string",
      "pattern": "^DSP-[A-Z0-9]{8}$",
      "description": "Unique identifier for this security packet"
    },
    "shiftId": {
      "type": "string",
      "description": "Associated Shift ID"
    },
    "createdAt": {
      "type": "string",
      "format": "date-time"
    },
    "expiresAt": {
      "type": "string",
      "format": "date-time"
    },
    "status": {
      "enum": ["draft", "approved", "active", "completed", "revoked"],
      "default": "draft"
    },

    "identityAccess": {
      "type": "object",
      "description": "Section A: Identity & Access",
      "required": ["identities", "roleBindings", "breakGlassPolicy"],
      "properties": {
        "identities": {
          "type": "object",
          "properties": {
            "acheevy": {
              "type": "object",
              "properties": {
                "id": {"type": "string"},
                "permissions": {"type": "array", "items": {"type": "string"}}
              }
            },
            "chickenHawk": {
              "type": "object",
              "properties": {
                "id": {"type": "string"},
                "permissions": {"type": "array", "items": {"type": "string"}}
              }
            },
            "lilHawks": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "id": {"type": "string"},
                  "designation": {"type": "string"},
                  "permissions": {"type": "array", "items": {"type": "string"}}
                }
              }
            }
          }
        },
        "roleBindings": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "role": {"type": "string"},
              "principal": {"type": "string"},
              "scope": {"type": "string"},
              "leastPrivilege": {"type": "boolean", "default": true}
            }
          }
        },
        "breakGlassPolicy": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean", "default": true},
            "approvers": {"type": "array", "items": {"type": "string"}},
            "auditRequired": {"type": "boolean", "default": true},
            "maxDuration": {"type": "integer", "description": "Max break-glass duration in seconds"}
          }
        },
        "mtlsRequired": {
          "type": "boolean",
          "default": true
        }
      }
    },

    "network": {
      "type": "object",
      "description": "Section B: Network",
      "required": ["mtlsRequired", "segmentationMap", "egressAllowlist"],
      "properties": {
        "mtlsRequired": {
          "type": "boolean",
          "default": true
        },
        "segmentationMap": {
          "type": "object",
          "properties": {
            "userPlane": {"type": "string", "description": "Isolated from control/worker"},
            "controlPlane": {"type": "string"},
            "workerPlane": {"type": "string"}
          }
        },
        "egressAllowlist": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "destination": {"type": "string"},
              "port": {"type": "integer"},
              "protocol": {"type": "string"},
              "reason": {"type": "string"}
            }
          },
          "description": "Default deny; only these are allowed"
        },
        "ingressPolicy": {
          "type": "object",
          "properties": {
            "chickenHawkIngress": {"type": "string", "enum": ["none", "internal_only"], "default": "none"},
            "lilHawkIngress": {"type": "string", "enum": ["none"], "default": "none"}
          }
        }
      }
    },

    "secretsData": {
      "type": "object",
      "description": "Section C: Secrets & Data",
      "required": ["injectionMethod", "secretScopes", "redactionPolicies"],
      "properties": {
        "injectionMethod": {
          "type": "string",
          "enum": ["env_vars", "mounted_secrets", "vault_sidecar"],
          "description": "Approved injection method only"
        },
        "secretScopes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "scope": {"type": "string"},
              "allowedCapabilities": {"type": "array", "items": {"type": "string"}}
            }
          }
        },
        "dataClassification": {
          "type": "object",
          "properties": {
            "public": {"type": "array", "items": {"type": "string"}},
            "internal": {"type": "array", "items": {"type": "string"}},
            "confidential": {"type": "array", "items": {"type": "string"}},
            "restricted": {"type": "array", "items": {"type": "string"}}
          }
        },
        "redactionPolicies": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "pattern": {"type": "string"},
              "action": {"type": "string", "enum": ["redact", "mask", "hash"]},
              "appliesTo": {"type": "array", "items": {"type": "string"}}
            }
          },
          "description": "No secrets in logs, receipts, or theater output"
        }
      }
    },

    "supplyChain": {
      "type": "object",
      "description": "Section D: Supply Chain",
      "required": ["sbomRequired", "signatureRequired", "malwareScanRequired"],
      "properties": {
        "sbomRequired": {
          "type": "boolean",
          "default": true
        },
        "signatureRequired": {
          "type": "boolean",
          "default": true
        },
        "malwareScanRequired": {
          "type": "boolean",
          "default": true
        },
        "registryAllowlist": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Allowed container registries"
        },
        "artifactAllowlist": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Allowed artifact types/sources"
        },
        "scanners": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Required scanning tools"
        }
      }
    },

    "runtimeHardening": {
      "type": "object",
      "description": "Section E: Runtime Hardening",
      "required": ["nonRootRequired", "privilegeEscalationDenied", "resourceLimits"],
      "properties": {
        "nonRootRequired": {
          "type": "boolean",
          "default": true
        },
        "privilegeEscalationDenied": {
          "type": "boolean",
          "default": true
        },
        "resourceLimits": {
          "type": "object",
          "properties": {
            "cpuLimit": {"type": "string"},
            "memoryLimit": {"type": "string"},
            "diskLimit": {"type": "string"},
            "networkBandwidth": {"type": "string"}
          }
        },
        "minimalBaseImages": {
          "type": "boolean",
          "default": true
        },
        "capabilityDrops": {
          "type": "array",
          "items": {"type": "string"},
          "default": ["CAP_SYS_ADMIN", "CAP_NET_ADMIN", "CAP_SYS_PTRACE"]
        },
        "readOnlyRootFilesystem": {
          "type": "boolean",
          "default": true
        }
      }
    },

    "detectionResponse": {
      "type": "object",
      "description": "Section F: Detection & Response",
      "required": ["anomalyTriggers", "autoActions", "incidentRouting"],
      "properties": {
        "anomalyTriggers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "condition": {"type": "string"},
              "threshold": {"type": "number"},
              "window": {"type": "string"},
              "severity": {"type": "string", "enum": ["low", "medium", "high", "critical"]}
            }
          }
        },
        "autoActions": {
          "type": "object",
          "properties": {
            "quarantine": {
              "type": "object",
              "properties": {
                "enabled": {"type": "boolean"},
                "triggers": {"type": "array", "items": {"type": "string"}}
              }
            },
            "killSwitch": {
              "type": "object",
              "properties": {
                "enabled": {"type": "boolean"},
                "triggers": {"type": "array", "items": {"type": "string"}}
              }
            },
            "rollback": {
              "type": "object",
              "properties": {
                "enabled": {"type": "boolean"},
                "triggers": {"type": "array", "items": {"type": "string"}},
                "errorRateThreshold": {"type": "number"}
              }
            },
            "hold": {
              "type": "object",
              "properties": {
                "enabled": {"type": "boolean"},
                "triggers": {"type": "array", "items": {"type": "string"}},
                "switchToGuideMe": {"type": "boolean", "default": true}
              }
            }
          }
        },
        "incidentRouting": {
          "type": "object",
          "properties": {
            "escalationPath": {"type": "array", "items": {"type": "string"}},
            "notificationChannels": {"type": "array", "items": {"type": "string"}},
            "oncallIntegration": {"type": "string"}
          }
        }
      }
    },

    "auditEvidence": {
      "type": "object",
      "description": "Section G: Audit Evidence",
      "required": ["kybFlightRecorderStreamId", "attestationPointers"],
      "properties": {
        "kybFlightRecorderStreamId": {
          "type": "string",
          "description": "Immutable event stream ID"
        },
        "attestationPointers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {"type": "string"},
              "location": {"type": "string"},
              "hash": {"type": "string"}
            }
          }
        },
        "scanResultPointers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "scanner": {"type": "string"},
              "location": {"type": "string"},
              "result": {"type": "string", "enum": ["pass", "fail", "warning"]}
            }
          }
        },
        "finalReceiptHash": {
          "type": "string",
          "description": "SHA-256 hash of final receipt"
        }
      }
    }
  }
}
