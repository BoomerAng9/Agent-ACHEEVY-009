{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aims.dev/schemas/deploy-shift-contract.json",
  "title": "Deploy Shift Contract",
  "description": "Schema for contracts between ACHEEVY, Boomer_Ang supervisors, and Chicken Hawk execution via Lil_Hawks",
  "version": "1.0.0",

  "definitions": {
    "ShiftOrder": {
      "type": "object",
      "description": "Permission to run a deployment session",
      "required": ["shiftId", "requestedBy", "approvedBy", "scope", "limits", "createdAt"],
      "properties": {
        "shiftId": {
          "type": "string",
          "pattern": "^SFT-[0-9]{3}$",
          "description": "Unique shift identifier"
        },
        "requestedBy": {
          "type": "string",
          "description": "User or system that requested the shift"
        },
        "approvedBy": {
          "type": "object",
          "required": ["acheevy", "boomerAng"],
          "properties": {
            "acheevy": {
              "type": "object",
              "required": ["approved", "timestamp", "planHash"],
              "properties": {
                "approved": { "type": "boolean" },
                "timestamp": { "type": "string", "format": "date-time" },
                "planHash": { "type": "string", "description": "SHA-256 hash of approved plan" }
              }
            },
            "boomerAng": {
              "type": "object",
              "required": ["validated", "timestamp", "supervisor", "scopeHash"],
              "properties": {
                "validated": { "type": "boolean" },
                "timestamp": { "type": "string", "format": "date-time" },
                "supervisor": { "type": "string", "description": "Boomer_Ang supervisor who validated" },
                "scopeHash": { "type": "string", "description": "SHA-256 hash of validated scope" }
              }
            }
          }
        },
        "scope": {
          "type": "object",
          "required": ["tenantId", "environment", "capabilities"],
          "properties": {
            "tenantId": { "type": "string" },
            "environment": { "enum": ["development", "staging", "production"] },
            "capabilities": {
              "type": "array",
              "items": { "type": "string" },
              "description": "List of capability IDs from Deploy Capability Registry"
            },
            "targetWorkloads": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        },
        "limits": {
          "type": "object",
          "required": ["maxLilHawks", "maxDuration", "budget"],
          "properties": {
            "maxLilHawks": { "type": "integer", "minimum": 1 },
            "maxDuration": { "type": "integer", "description": "Max duration in seconds" },
            "budget": {
              "type": "object",
              "required": ["currency", "amount", "lucApproved"],
              "properties": {
                "currency": { "type": "string", "default": "USD" },
                "amount": { "type": "number", "minimum": 0 },
                "lucApproved": { "type": "boolean", "description": "LUC budget gate passed" }
              }
            },
            "concurrency": { "type": "integer", "minimum": 1, "default": 1 }
          }
        },
        "createdAt": { "type": "string", "format": "date-time" },
        "expiresAt": { "type": "string", "format": "date-time" }
      }
    },

    "Manifest": {
      "type": "object",
      "description": "The detailed work plan generated by ACHEEVY",
      "required": ["manifestId", "shiftId", "waves", "rollbackTriggers", "createdAt"],
      "properties": {
        "manifestId": {
          "type": "string",
          "pattern": "^MAN-[A-Z0-9]{8}$"
        },
        "shiftId": { "type": "string" },
        "description": { "type": "string" },
        "waves": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["waveNumber", "steps"],
            "properties": {
              "waveNumber": { "type": "integer", "minimum": 1 },
              "description": { "type": "string" },
              "steps": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["stepId", "capability", "target", "params"],
                  "properties": {
                    "stepId": { "type": "string" },
                    "capability": { "type": "string", "description": "Capability ID from registry" },
                    "target": { "type": "string", "description": "Target workload or resource" },
                    "params": { "type": "object" },
                    "botAssignment": { "type": "string", "description": "Bot moniker if pre-assigned" },
                    "dependsOn": {
                      "type": "array",
                      "items": { "type": "string" },
                      "description": "Step IDs this step depends on"
                    }
                  }
                }
              },
              "gateCondition": {
                "type": "string",
                "description": "Condition to pass before proceeding to next wave"
              }
            }
          }
        },
        "rollbackTriggers": {
          "type": "object",
          "properties": {
            "errorRateThreshold": { "type": "number", "minimum": 0, "maximum": 1 },
            "latencyThresholdMs": { "type": "integer" },
            "healthCheckFailures": { "type": "integer" },
            "manualTrigger": { "type": "boolean", "default": true }
          }
        },
        "expectedOutputs": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": { "type": "string" },
              "description": { "type": "string" }
            }
          }
        },
        "createdAt": { "type": "string", "format": "date-time" },
        "hash": { "type": "string", "description": "SHA-256 hash of manifest content" }
      }
    },

    "CrewAssignments": {
      "type": "object",
      "description": "Which Boomer_Ang supervisors are responsible for this shift",
      "required": ["shiftId", "supervisors", "workers"],
      "properties": {
        "shiftId": { "type": "string" },
        "supervisors": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["role", "moniker", "responsibilities"],
            "properties": {
              "role": { "type": "string" },
              "moniker": { "type": "string" },
              "responsibilities": {
                "type": "array",
                "items": { "type": "string" }
              },
              "kybIdentity": { "type": "string" }
            }
          }
        },
        "workers": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["moniker", "crewRole", "capabilities"],
            "properties": {
              "moniker": { "type": "string" },
              "crewRole": { "type": "string" },
              "capabilities": {
                "type": "array",
                "items": { "type": "string" }
              },
              "kybIdentity": { "type": "string" }
            }
          }
        }
      }
    },

    "Receipt": {
      "type": "object",
      "description": "Final proof of what ran, changed, costs, and checks",
      "required": ["receiptId", "shiftId", "manifestId", "status", "summary", "audit", "createdAt"],
      "properties": {
        "receiptId": {
          "type": "string",
          "pattern": "^RCP-[A-Z0-9]{8}$"
        },
        "shiftId": { "type": "string" },
        "manifestId": { "type": "string" },
        "status": {
          "enum": ["completed", "failed", "rolled_back", "cancelled"]
        },
        "summary": {
          "type": "object",
          "properties": {
            "stepsExecuted": { "type": "integer" },
            "stepsSucceeded": { "type": "integer" },
            "stepsFailed": { "type": "integer" },
            "wavesCompleted": { "type": "integer" },
            "lilHawksSpawned": { "type": "integer" },
            "squadId": { "type": "string" },
            "durationMs": { "type": "integer" }
          }
        },
        "changes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": { "type": "string" },
              "target": { "type": "string" },
              "before": { "type": "object" },
              "after": { "type": "object" },
              "timestamp": { "type": "string", "format": "date-time" }
            }
          }
        },
        "costs": {
          "type": "object",
          "properties": {
            "currency": { "type": "string" },
            "compute": { "type": "number" },
            "storage": { "type": "number" },
            "network": { "type": "number" },
            "total": { "type": "number" },
            "lucReference": { "type": "string" }
          }
        },
        "audit": {
          "type": "object",
          "required": ["kybVerified", "approvalChain", "flightRecorderRef"],
          "properties": {
            "kybVerified": { "type": "boolean" },
            "approvalChain": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "actor": { "type": "string" },
                  "action": { "type": "string" },
                  "timestamp": { "type": "string", "format": "date-time" },
                  "signature": { "type": "string" }
                }
              }
            },
            "flightRecorderRef": { "type": "string" },
            "contractHashes": {
              "type": "object",
              "properties": {
                "shiftOrder": { "type": "string" },
                "manifest": { "type": "string" }
              }
            }
          }
        },
        "verifiedBy": {
          "type": "object",
          "properties": {
            "acheevy": {
              "type": "object",
              "properties": {
                "verified": { "type": "boolean" },
                "timestamp": { "type": "string", "format": "date-time" },
                "notes": { "type": "string" }
              }
            }
          }
        },
        "createdAt": { "type": "string", "format": "date-time" }
      }
    }
  },

  "type": "object",
  "required": ["contractVersion", "shiftOrder", "manifest", "crewAssignments"],
  "properties": {
    "contractVersion": {
      "type": "string",
      "const": "1.0.0"
    },
    "shiftOrder": { "$ref": "#/definitions/ShiftOrder" },
    "manifest": { "$ref": "#/definitions/Manifest" },
    "crewAssignments": { "$ref": "#/definitions/CrewAssignments" },
    "receipt": { "$ref": "#/definitions/Receipt" }
  },

  "workflow": {
    "description": "Contract flow matching governance model",
    "steps": [
      {
        "step": 1,
        "actor": "ACHEEVY",
        "action": "Creates Manifest from NLP + context",
        "output": "manifest"
      },
      {
        "step": 2,
        "actor": "Boomer_Ang Supervisor",
        "action": "Signs the Shift Order after validating scope",
        "output": "shiftOrder.approvedBy.boomerAng"
      },
      {
        "step": 3,
        "actor": "Chicken Hawk (via Squad)",
        "action": "Executes the manifest exactly",
        "output": "execution logs"
      },
      {
        "step": 4,
        "actor": "Lil_Hawks",
        "action": "Run atomic tasks and emit logs",
        "output": "flight recorder entries"
      },
      {
        "step": 5,
        "actor": "ACHEEVY",
        "action": "Verifies + publishes Receipt",
        "output": "receipt"
      }
    ],
    "mandatoryGates": [
      "LUC.canExecute (budget)",
      "Capability exists in Deploy Capability Registry",
      "KYB identity for every worker",
      "Kill switch armed"
    ]
  }
}
