version: '3.8'
name: aims-chickenhawk

# ===========================================================================
# Chicken Hawk Service Cluster — A.I.M.S. Execution Engine
#
# 4 services per CHICKENHAWK_SPEC.md:
#   chickenhawk-core    (4001) — Planner/executor/verifier loop
#   chickenhawk-policy  (4002) — Circuit Box policy enforcement
#   chickenhawk-audit   (4003) — Immutable event log + evidence locker
#   chickenhawk-voice   (4004) — Voice I/O routing (STT/TTS)
#
# Usage:
#   docker compose -f docker-compose.chickenhawk.yml up -d
#
# All services communicate over aims-network. Core depends on policy
# and audit being healthy before starting.
# ===========================================================================

services:
  # -------------------------------------------------------------------------
  # chickenhawk-core: Main execution engine (port 4001)
  # Receives manifests, spawns Squads of Lil_Hawks, executes waves
  # -------------------------------------------------------------------------
  chickenhawk-core:
    build:
      context: ../services/chicken-hawk
      dockerfile: Dockerfile
    container_name: chickenhawk-core
    ports:
      - "4001:4001"
    environment:
      - PORT=4001
      - NODE_ENV=production
      - POLICY_URL=http://chickenhawk-policy:4002
      - AUDIT_URL=http://chickenhawk-audit:4003
      - N8N_URL=http://n8n:5678
      - AGENT_BRIDGE_URL=http://agent-bridge:3010
      - ACHEEVY_URL=http://acheevy:3003
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
    volumes:
      - chickenhawk-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    depends_on:
      chickenhawk-policy:
        condition: service_healthy
      chickenhawk-audit:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    networks:
      - aims-network

  # -------------------------------------------------------------------------
  # chickenhawk-policy: Circuit Box policy enforcement (port 4002)
  # Badge-level gating, tool permissions, budget caps, kill switch
  # -------------------------------------------------------------------------
  chickenhawk-policy:
    build:
      context: ../services/chicken-hawk
      dockerfile: Dockerfile
    container_name: chickenhawk-policy
    command: ["bun", "run", "src/policy/server.ts"]
    ports:
      - "4002:4002"
    environment:
      - PORT=4002
      - NODE_ENV=production
      - CIRCUIT_BOX_CONFIG=/config/circuit-box.json
    volumes:
      - ../infra/deploy-platform:/config:ro
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:4002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    networks:
      - aims-network

  # -------------------------------------------------------------------------
  # chickenhawk-audit: Immutable event log + evidence locker (port 4003)
  # Flight recorder, JSONL logs, 90-day retention, structured timelines
  # -------------------------------------------------------------------------
  chickenhawk-audit:
    build:
      context: ../services/chicken-hawk
      dockerfile: Dockerfile
    container_name: chickenhawk-audit
    command: ["bun", "run", "src/audit/server.ts"]
    ports:
      - "4003:4003"
    environment:
      - PORT=4003
      - NODE_ENV=production
      - EVIDENCE_DIR=/data/evidence
      - RETENTION_DAYS=90
    volumes:
      - chickenhawk-evidence:/data/evidence
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:4003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    networks:
      - aims-network

  # -------------------------------------------------------------------------
  # chickenhawk-voice: Voice gateway (port 4004)
  # STT (Groq Whisper / Deepgram) → TTS (ElevenLabs / Deepgram)
  # -------------------------------------------------------------------------
  chickenhawk-voice:
    build:
      context: ../services/chicken-hawk
      dockerfile: Dockerfile
    container_name: chickenhawk-voice
    command: ["bun", "run", "src/voice/server.ts"]
    ports:
      - "4004:4004"
    environment:
      - PORT=4004
      - NODE_ENV=production
      - CORE_URL=http://chickenhawk-core:4001
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - ELEVENLABS_VOICE_ID=${ELEVENLABS_VOICE_ID:-pNInz6obpgDQGcFmaJgB}
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:4004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    depends_on:
      chickenhawk-core:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    networks:
      - aims-network

# ===========================================================================
# Volumes
# ===========================================================================
volumes:
  chickenhawk-data:
    driver: local
  chickenhawk-evidence:
    driver: local

# ===========================================================================
# Networks — join the existing AIMS network
# ===========================================================================
networks:
  aims-network:
    external: true
