# A.I.M.S. Docker Deployment - VPS Production Stack
# Includes: Core Services, Agent Sandbox, Security Layer
#
# Architecture:
# ┌─────────────────────────────────────────────────────────────────┐
# │  Nginx Reverse Proxy (SSL/TLS Termination)                     │
# └─────────────────────────────────────────────────────────────────┘
#              │
# ┌────────────┴────────────────────────────────────────────────────┐
# │  AIMS Network (Internal)                                        │
# │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
# │  │   Frontend   │  │ UEF Gateway  │  │   ACHEEVY    │          │
# │  │  (Next.js)   │  │ (Orchestrator)│  │  (Executive) │          │
# │  └──────────────┘  └──────────────┘  └──────────────┘          │
# │         │                 │                 │                   │
# │  ┌──────┴─────────────────┴─────────────────┴────────┐         │
# │  │              House of Ang (Agent Registry)         │         │
# │  └────────────────────────────────────────────────────┘         │
# └─────────────────────────────────────────────────────────────────┘
#              │
# ┌────────────┴────────────────────────────────────────────────────┐
# │  Agent Sandbox Network (Isolated)                               │
# │  ┌──────────────┐  ┌──────────────┐                            │
# │  │   n8n        │  │  Agent Zero  │                            │
# │  │ (Automation) │  │  (Research)  │                            │
# │  └──────────────┘  └──────────────┘                            │
# └─────────────────────────────────────────────────────────────────┘

version: '3.8'

# ═══════════════════════════════════════════════════════════════════
# NETWORKS
# ═══════════════════════════════════════════════════════════════════

networks:
  # Main application network
  aims-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

  # Isolated sandbox network for agents (no internet by default)
  sandbox-network:
    driver: bridge
    internal: true  # No external access
    ipam:
      config:
        - subnet: 172.21.0.0/16

  # Proxy network for external access
  proxy-network:
    driver: bridge

# ═══════════════════════════════════════════════════════════════════
# VOLUMES
# ═══════════════════════════════════════════════════════════════════

volumes:
  # Persistent data
  aims-data:
    driver: local
  luc-data:
    driver: local
  n8n-data:
    driver: local
  redis-data:
    driver: local

  # Shared workspace (read-only for agents)
  shared-workspace:
    driver: local

services:
  # ═════════════════════════════════════════════════════════════════
  # LAYER 0: INFRASTRUCTURE
  # ═════════════════════════════════════════════════════════════════

  # Nginx Reverse Proxy with SSL
  nginx:
    image: nginx:alpine
    container_name: aims-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - frontend
      - uef-gateway
    networks:
      - proxy-network
      - aims-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis for caching and session management
  redis:
    image: redis:7-alpine
    container_name: aims-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-aims_redis_secret}
    volumes:
      - redis-data:/data
    networks:
      - aims-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ═════════════════════════════════════════════════════════════════
  # LAYER 1: FRONTEND
  # ═════════════════════════════════════════════════════════════════

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
    container_name: aims-frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_ACP_ENDPOINT=/api/acp
      - UEF_GATEWAY_URL=http://uef-gateway:3001
      - HOUSE_OF_ANG_URL=http://house-of-ang:3002
      - ACHEEVY_URL=http://acheevy:3003
      - REDIS_URL=redis://:${REDIS_PASSWORD:-aims_redis_secret}@redis:6379
    volumes:
      - luc-data:/app/.luc-data
    depends_on:
      - redis
      - uef-gateway
      - house-of-ang
      - acheevy
    networks:
      - aims-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    # Security: Run as non-root
    user: "1000:1000"
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ═════════════════════════════════════════════════════════════════
  # LAYER 2: CORE SERVICES
  # ═════════════════════════════════════════════════════════════════

  # UEF Gateway - Main Orchestrator
  uef-gateway:
    build:
      context: ../backend/uef-gateway
      dockerfile: Dockerfile
    container_name: aims-uef-gateway
    env_file:
      - .env
    environment:
      - PORT=3001
      - NODE_ENV=production
      - HOUSE_OF_ANG_URL=http://house-of-ang:3002
      - ACHEEVY_URL=http://acheevy:3003
      - REDIS_URL=redis://:${REDIS_PASSWORD:-aims_redis_secret}@redis:6379
      # Security: Disable debug in production
      - DEBUG=false
      - LOG_LEVEL=info
    volumes:
      - aims-data:/app/data
    depends_on:
      - redis
      - house-of-ang
    networks:
      - aims-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    user: "1000:1000"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # House of Ang - Boomer_Ang Registry & Routing
  house-of-ang:
    build:
      context: ../backend/house-of-ang
      dockerfile: Dockerfile
    container_name: aims-house-of-ang
    environment:
      - PORT=3002
      - NODE_ENV=production
      - REGISTRY_PATH=/app/registry/registry.json
      - REDIS_URL=redis://:${REDIS_PASSWORD:-aims_redis_secret}@redis:6379
    volumes:
      - ../infra/boomerangs:/app/registry:ro
    depends_on:
      - redis
    networks:
      - aims-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    user: "1000:1000"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ACHEEVY - Executive Orchestrator (PAYMENTS ONLY HERE)
  acheevy:
    build:
      context: ../backend/acheevy
      dockerfile: Dockerfile
    container_name: aims-acheevy
    environment:
      - PORT=3003
      - NODE_ENV=production
      - HOUSE_OF_ANG_URL=http://house-of-ang:3002
      - UEF_GATEWAY_URL=http://uef-gateway:3001
      - REDIS_URL=redis://:${REDIS_PASSWORD:-aims_redis_secret}@redis:6379
      # Payment credentials (ACHEEVY ONLY - NEVER expose to agents)
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
    depends_on:
      - redis
      - house-of-ang
    networks:
      - aims-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    user: "1000:1000"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ═════════════════════════════════════════════════════════════════
  # LAYER 3: AGENT SANDBOX (ISOLATED)
  # ═════════════════════════════════════════════════════════════════

  # Agent Gateway Bridge - Controlled access between networks
  agent-bridge:
    build:
      context: ./agent-bridge
      dockerfile: Dockerfile
    container_name: aims-agent-bridge
    environment:
      - PORT=3010
      - AIMS_GATEWAY_URL=http://uef-gateway:3001
      # Security: Rate limiting
      - RATE_LIMIT_REQUESTS=100
      - RATE_LIMIT_WINDOW=60000
      # Security: Allowed operations (whitelist)
      - ALLOWED_OPS=search,analyze,summarize,generate
      # BLOCKED: payment, transfer, purchase, checkout
      - BLOCKED_OPS=payment,transfer,purchase,checkout,buy,order,credit_card
    networks:
      - aims-network
      - sandbox-network
    depends_on:
      - uef-gateway
    restart: unless-stopped
    user: "1000:1000"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ═════════════════════════════════════════════════════════════════
  # LAYER 3.1: AUTOMATION TOOLS
  # ═════════════════════════════════════════════════════════════════

  # n8n - Workflow Automation (Sandboxed)
  n8n:
    image: n8nio/n8n:latest
    container_name: aims-n8n
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-http://localhost:5678}
      # Security
      - N8N_HIRING_BANNER_ENABLED=false
      - N8N_DIAGNOSTICS_ENABLED=false
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      - sandbox-network
    restart: unless-stopped
    user: "1000:1000"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ═════════════════════════════════════════════════════════════════
  # LAYER 4: MONITORING & OBSERVABILITY
  # ═════════════════════════════════════════════════════════════════

  # Circuit Box Metrics Exporter
  circuit-metrics:
    build:
      context: ./circuit-metrics
      dockerfile: Dockerfile
    container_name: aims-circuit-metrics
    environment:
      - PORT=9090
      - UEF_GATEWAY_URL=http://uef-gateway:3001
      - HOUSE_OF_ANG_URL=http://house-of-ang:3002
      - ACHEEVY_URL=http://acheevy:3003
      - AGENT_BRIDGE_URL=http://agent-bridge:3010
    networks:
      - aims-network
    depends_on:
      - uef-gateway
      - house-of-ang
      - acheevy
      - agent-bridge
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
