// frontend/prisma/schema.prisma
// LUC (Ledger Usage Calculator) Database Schema
// @version 2.0.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────────────────────────
// Core Entities
// ─────────────────────────────────────────────────────────────────────────────

/// User account with authentication
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  role          String    @default("MEMBER")
  status        String    @default("ACTIVE")

  // Workspace membership
  workspaces    WorkspaceMember[]

  // Audit trail
  auditLogs     AuditLog[]
  policyChanges PolicyVersion[] @relation("CreatedBy")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}



/// Workspace (tenant) - primary scope for LUC
model Workspace {
  id            String    @id @default(uuid())
  name          String
  slug          String    @unique

  // LUC account
  lucAccount    LucAccount?

  // Members
  members       WorkspaceMember[]

  // Usage tracking
  usageEvents   UsageEvent[]

  // Policy
  policies      PolicyVersion[]

  // Audit
  auditLogs     AuditLog[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

/// Workspace membership (many-to-many)
model WorkspaceMember {
  id          String    @id @default(uuid())
  userId      String
  workspaceId String
  role        String        @default("MEMBER")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())

  @@unique([userId, workspaceId])
}



// ─────────────────────────────────────────────────────────────────────────────
// LUC Account and Quotas
// ─────────────────────────────────────────────────────────────────────────────

/// LUC account state per workspace
model LucAccount {
  id            String    @id @default(uuid())
  workspaceId   String    @unique
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Plan info
  planId        String    @default("free")
  status        String        @default("ACTIVE")

  // Quotas stored as JSON (flexible for service additions)
  quotas        String    // JSON: Record<ServiceKey, Quota>

  // Overage policy
  overagePolicy String    @default("block")

  // Billing period
  periodStart   DateTime
  periodEnd     DateTime

  // Stripe integration (optional)
  stripeCustomerId    String?
  stripeSubscriptionId String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}



// ─────────────────────────────────────────────────────────────────────────────
// Usage Events (Append-Only)
// ─────────────────────────────────────────────────────────────────────────────

/// Usage event - immutable record of resource consumption
model UsageEvent {
  id            String    @id @default(uuid())
  workspaceId   String
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Event details
  userId        String?
  serviceKey    String    // Service being metered
  units         Float     // Amount consumed
  cost          Float     // Calculated cost
  eventType     String    @default("USAGE")

  // Tracing
  requestId     String?   // Request correlation ID

  // Metadata (JSON for flexibility)
  metadata      String?   // JSON: { toolId, route, boomerAngOwner, etc. }

  timestamp     DateTime  @default(now())

  @@index([workspaceId, serviceKey, timestamp])
  @@index([workspaceId, timestamp])
}



// ─────────────────────────────────────────────────────────────────────────────
// Policy Management
// ─────────────────────────────────────────────────────────────────────────────

/// Policy versions with draft/effective states
model PolicyVersion {
  id            String    @id @default(uuid())

  // Scope
  scope         String
  scopeId       String?   // workspace/project/env ID (null for platform)
  workspaceId   String?
  workspace     Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Version control
  version       Int       @default(1)
  status        String       @default("DRAFT")

  // Policy content (JSON)
  policy        String    // JSON: The actual policy configuration

  // Audit
  createdById   String
  createdBy     User      @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt     DateTime  @default(now())
  effectiveAt   DateTime?
  supersededAt  DateTime?

  @@index([scope, scopeId, status])
  @@index([workspaceId, status])
}



// ─────────────────────────────────────────────────────────────────────────────
// Audit Log
// ─────────────────────────────────────────────────────────────────────────────

/// Audit log for security and compliance
model AuditLog {
  id            String    @id @default(uuid())

  // Actor
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  workspaceId   String?
  workspace     Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  // Action
  action        String    // e.g., "policy.update", "quota.adjust"
  resource      String    // Resource type
  resourceId    String?   // Resource ID

  // Change tracking (JSON)
  previousValue String?   // JSON: Previous state
  newValue      String?   // JSON: New state
  reason        String?   // Why the change was made

  // Request context
  ipAddress     String?
  userAgent     String?

  timestamp     DateTime  @default(now())

  @@index([workspaceId, timestamp])
  @@index([userId, timestamp])
  @@index([resource, resourceId])
}

// ─────────────────────────────────────────────────────────────────────────────
// Evidence Storage (for Gates)
// ─────────────────────────────────────────────────────────────────────────────

/// Evidence run record
model EvidenceRun {
  id            String    @id @default(uuid())

  // Gate info
  gateName      String    // e.g., "lint", "test", "security-scan"
  status        String

  // Timing
  startedAt     DateTime
  completedAt   DateTime?
  durationMs    Int?

  // Results
  summary       String?   // Brief summary
  artifactPath  String?   // Path to artifacts

  // Metadata
  gitCommit     String?
  gitBranch     String?
  triggeredBy   String?   // "ci", "manual", etc.

  createdAt     DateTime  @default(now())

  @@index([gateName, createdAt])
}



// ─────────────────────────────────────────────────────────────────────────────
// Presets (for Flip Secrets, etc.)
// ─────────────────────────────────────────────────────────────────────────────

/// Preset calculation template
model Preset {
  id            String    @id @default(uuid())
  slug          String    @unique
  name          String
  version       String
  category      String
  description   String?

  // Preset definition (JSON)
  definition    String    // JSON: { inputFields, outputFields, formulas }

  // Status
  isActive      Boolean   @default(true)
  isBuiltIn     Boolean   @default(false)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

/// Saved preset calculation
model PresetCalculation {
  id            String    @id @default(uuid())
  presetId      String
  workspaceId   String

  // User inputs and results (JSON)
  inputs        String    // JSON: User-provided values
  outputs       String    // JSON: Calculated results

  // Metadata
  name          String?   // User-defined name for this calculation
  notes         String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([workspaceId, presetId])
}

// ─────────────────────────────────────────────────────────────────────────────
// Active Boomer_Angs Tracking
// ─────────────────────────────────────────────────────────────────────────────

/// Active Boomer_Ang session
model ActiveBoomerAng {
  id            String    @id @default(uuid())
  workspaceId   String
  boomerAngId   String    // Agent identifier
  boomerAngName String    // Display name

  // Session info
  startedAt     DateTime  @default(now())
  lastHeartbeat DateTime  @default(now())

  // Task context
  currentTask   String?
  deploymentId  String?

  @@index([workspaceId])
  @@unique([workspaceId, boomerAngId])
}

// ─────────────────────────────────────────────────────────────────────────────
// The Arena — Contest & Gamification Platform
// ─────────────────────────────────────────────────────────────────────────────

/// Arena player profile (extends User for contest participation)
model ArenaPlayer {
  id            String    @id @default(uuid())
  userId        String    @unique
  displayName   String
  avatarUrl     String?
  tier          String    @default("ROOKIE")  // ROOKIE, CONTENDER, VETERAN, ELITE, LEGEND
  xp            Int       @default(0)
  level         Int       @default(1)
  winCount      Int       @default(0)
  totalContests Int       @default(0)
  winRate       Float     @default(0)
  streak        Int       @default(0)
  bestStreak    Int       @default(0)

  // Wallet
  wallet        ArenaWallet?

  // Contest entries
  entries       ArenaEntry[]

  // Leaderboard entries
  leaderboard   ArenaLeaderboard[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tier, xp])
  @@index([winRate])
}

/// Player wallet for contest entry fees and winnings
model ArenaWallet {
  id            String    @id @default(uuid())
  playerId      String    @unique
  player        ArenaPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)
  balance       Float     @default(0)     // Available balance in USD
  totalDeposited Float    @default(0)
  totalWon      Float     @default(0)
  totalSpent    Float     @default(0)

  // Stripe
  stripeCustomerId String?

  transactions  ArenaWalletTx[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

/// Wallet transaction log (append-only)
model ArenaWalletTx {
  id            String    @id @default(uuid())
  walletId      String
  wallet        ArenaWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  type          String    // DEPOSIT, ENTRY_FEE, WINNINGS, REFUND, BONUS
  amount        Float
  balanceAfter  Float
  description   String
  referenceId   String?   // contestId or stripe paymentId
  stripePaymentId String?

  createdAt     DateTime  @default(now())

  @@index([walletId, createdAt])
  @@index([type, createdAt])
}

/// A contest (trivia round, pick'em slate, etc.)
model ArenaContest {
  id            String    @id @default(uuid())
  slug          String    @unique
  title         String
  description   String
  type          String    // TRIVIA, PICKEM, PROSPECT_RANK, OVER_UNDER, STREAK
  category      String    // SPORTS, GENERAL, ENTERTAINMENT, SCIENCE, HISTORY, MIXED
  status        String    @default("UPCOMING")  // UPCOMING, LIVE, SCORING, COMPLETED, CANCELLED
  entryFee      Float     @default(0)   // 0 = free contest
  prizePool     Float     @default(0)
  rakePercent   Float     @default(15)  // Platform take percentage
  maxEntries    Int       @default(100)
  minEntries    Int       @default(2)
  currentEntries Int      @default(0)

  // Timing
  startsAt      DateTime
  endsAt        DateTime
  scoredAt      DateTime?

  // Contest data (JSON) — questions, picks, scoring rules
  contestData   String    // JSON: questions/picks/rules

  // Prize structure (JSON)
  prizeStructure String   // JSON: { 1st: 50%, 2nd: 30%, 3rd: 20% }

  // Auto-generated metadata
  generatedBy   String    @default("SYSTEM")
  difficulty    String    @default("MEDIUM")  // EASY, MEDIUM, HARD, EXPERT
  featured      Boolean   @default(false)

  // Relations
  entries       ArenaEntry[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status, startsAt])
  @@index([type, status])
  @@index([featured, status])
  @@index([category, status])
}

/// A player's entry into a contest
model ArenaEntry {
  id            String    @id @default(uuid())
  contestId     String
  contest       ArenaContest @relation(fields: [contestId], references: [id], onDelete: Cascade)
  playerId      String
  player        ArenaPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)

  // Submission
  answers       String    // JSON: Array of answers/picks
  submittedAt   DateTime?
  isSubmitted   Boolean   @default(false)

  // Scoring
  score         Float?
  rank          Int?
  correctCount  Int?
  totalQuestions Int?
  payout        Float     @default(0)

  // Entry fee paid
  entryFeePaid  Float     @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([contestId, playerId])
  @@index([playerId, createdAt])
  @@index([contestId, score])
}

/// Global leaderboard (weekly/monthly/all-time snapshots)
model ArenaLeaderboard {
  id            String    @id @default(uuid())
  playerId      String
  player        ArenaPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)
  period        String    // WEEKLY, MONTHLY, ALL_TIME, SEASON_1
  periodKey     String    // e.g., "2026-W07", "2026-02", "all"
  rank          Int
  score         Float     @default(0)
  wins          Int       @default(0)
  entries       Int       @default(0)
  earnings      Float     @default(0)
  accuracy      Float     @default(0)

  updatedAt     DateTime  @updatedAt

  @@unique([playerId, period, periodKey])
  @@index([period, periodKey, rank])
  @@index([period, periodKey, score])
}

/// Imported trivia questions from OpenTDB and other sources
model TriviaQuestion {
  id            String    @id @default(uuid())
  source        String    @default("opentdb")   // opentdb, custom, ai_generated
  externalId    String?
  category      String
  difficulty    String    // easy, medium, hard
  type          String    @default("multiple")  // multiple, boolean
  question      String
  correctAnswer String
  incorrectAnswers String  // JSON array
  tags          String?    // JSON array
  timesUsed     Int       @default(0)
  timesCorrect  Int       @default(0)

  createdAt     DateTime  @default(now())

  @@index([category, difficulty])
  @@index([source])
  @@index([timesUsed])
}

// ─────────────────────────────────────────────────────────────────────────────
// Per|Form — CFB Recruiting & Analytics
// ─────────────────────────────────────────────────────────────────────────────

/// CFB Conference
model PerformConference {
  id            String    @id @default(uuid())
  name          String    @unique
  abbreviation  String    @unique
  tier          String    // power4, group_of_5, independent
  commissioner  String?
  hqCity        String?
  hqState       String?
  founded       Int?

  teams         PerformTeam[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

/// CFB Team
model PerformTeam {
  id            String    @id @default(uuid())
  schoolName    String
  commonName    String
  abbreviation  String
  mascot        String
  city          String
  state         String
  stadium       String
  stadiumCapacity Int     @default(0)
  colors        String    // JSON: [{name, hex}]
  headCoach     String
  headCoachSince Int      @default(2024)
  bio           String?
  founded       Int?
  enrollment    Int?

  conferenceId  String
  conference    PerformConference @relation(fields: [conferenceId], references: [id])

  // Roster / recruits
  prospects     PerformProspect[] @relation("CommittedTo")

  // Season records
  seasons       PerformTeamSeason[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([schoolName, state])
  @@index([conferenceId])
}

/// CFB Team Season Record
model PerformTeamSeason {
  id            String    @id @default(uuid())
  teamId        String
  team          PerformTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  season        Int       // e.g., 2025
  wins          Int       @default(0)
  losses        Int       @default(0)
  confWins      Int       @default(0)
  confLosses    Int       @default(0)
  apRank        Int?      // Final AP ranking
  cfpRank       Int?      // Final CFP ranking
  bowlGame      String?
  bowlResult    String?   // W or L
  notes         String?

  createdAt     DateTime  @default(now())

  @@unique([teamId, season])
  @@index([season])
}

/// Recruiting Prospect
model PerformProspect {
  id            String    @id @default(uuid())
  slug          String    @unique

  // Identity
  firstName     String
  lastName      String
  position      String
  classYear     String    // e.g., "'26"
  school        String    // HS or college name
  state         String
  pool          String    @default("HIGH_SCHOOL") // HIGH_SCHOOL, COLLEGE

  // Physical
  height        String?   // e.g., "6'2\""
  weight        Int?
  gpa           Float?

  // P.A.I. Grade
  paiScore      Int       @default(0)
  tier          String    @default("DEVELOPMENTAL") // ELITE, BLUE_CHIP, PROSPECT, SLEEPER, DEVELOPMENTAL
  performance   Int       @default(0)
  athleticism   Int       @default(0)
  intangibles   Int       @default(0)

  // Rankings
  nationalRank  Int       @default(9999)
  stateRank     Int       @default(9999)
  positionRank  Int       @default(9999)
  trend         String    @default("NEW") // UP, DOWN, STEADY, NEW
  previousRank  Int?

  // NIL
  nilEstimate   String?

  // Scouting
  scoutMemo     String?
  tags          String?   // JSON array
  comparisons   String?   // JSON array
  stats         String?   // JSON: Record<string, string|number>

  // Debate
  bullCase      String?
  bearCase      String?
  mediationVerdict String?
  debateWinner  String?   // BULL, BEAR, SPLIT

  // Media
  highlightsUrl String?
  imageUrl      String?

  // Commitment
  committedTeamId String?
  committedTeam   PerformTeam? @relation("CommittedTo", fields: [committedTeamId], references: [id])
  commitDate      DateTime?
  stars           Int?      // 2-5 star rating from composite

  // Data provenance
  sourceUrls    String?   // JSON: URLs used for data
  lastEnriched  DateTime?
  enrichedBy    String?   // "brave_search", "manual", "scout_hub"

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tier, nationalRank])
  @@index([position, classYear])
  @@index([state, classYear])
  @@index([pool, classYear])
}

/// Per|Form Content (blog posts, podcasts, scouting reports)
model PerformContent {
  id            String    @id @default(uuid())
  slug          String    @unique
  type          String    // BLOG, PODCAST, RANKING_UPDATE, SCOUTING_REPORT, DEBATE_RECAP
  title         String
  excerpt       String?
  body          String?
  prospectId    String?
  prospectName  String?
  generatedBy   String    @default("SYSTEM")
  readTimeMin   Int       @default(5)
  tags          String?   // JSON array
  imageUrl      String?
  audioUrl      String?
  published     Boolean   @default(false)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([type, published])
  @@index([createdAt])
}

// ─────────────────────────────────────────────────────────────────────────────
// Per|Form — NFL Draft & Mock Draft Engine
// ─────────────────────────────────────────────────────────────────────────────

/// NFL Draft-eligible prospect
model DraftProspect {
  id            String    @id @default(uuid())
  slug          String    @unique

  // Identity
  firstName     String
  lastName      String
  position      String
  college       String
  conference    String?
  classYear     String    // Senior, R-Senior, Junior (declared), etc.
  eligibility   String?   // e.g., "RS-Senior", "Junior (declared)"

  // Physical
  height        String?
  weight        Int?
  armLength     String?
  handSize      String?
  fortyYard     Float?    // 40-yard dash
  benchPress    Int?      // 225lb reps
  verticalJump  Float?
  broadJump     Int?      // inches
  threeCone     Float?
  shuttle       Float?

  // Grade (P.A.I. for NFL Draft)
  paiScore      Int       @default(0)
  tier          String    @default("DAY_3")  // TOP_5, TOP_15, FIRST_ROUND, DAY_2, DAY_3, PRIORITY_UDFA, UDFA
  performance   Int       @default(0)
  athleticism   Int       @default(0)
  intangibles   Int       @default(0)

  // Rankings
  overallRank   Int       @default(9999)
  positionRank  Int       @default(9999)
  trend         String    @default("NEW")

  // Scouting
  scoutMemo     String?
  tags          String?         // JSON array
  comparisons   String?         // JSON array
  collegeStats  String?         // JSON: career stats
  seniorBowl    Boolean   @default(false)
  combineInvite Boolean   @default(false)

  // Debate
  bullCase      String?
  bearCase      String?
  mediationVerdict String?
  debateWinner  String?

  // Projection
  projectedRound Int?     // 1-7
  projectedPick  Int?     // 1-262
  projectedTeam  String?  // NFL team name

  // Data provenance
  cfbdPlayerId  Int?      // CollegeFootballData.com player ID
  sourceUrls    String?   // JSON array
  lastEnriched  DateTime?
  enrichedBy    String?

  // Mock draft appearances
  mockDraftPicks DraftPick[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tier, overallRank])
  @@index([position])
  @@index([college])
}

/// NFL Team draft needs and picks
model NFLTeamNeeds {
  id            String    @id @default(uuid())
  teamName      String    @unique  // e.g., "Chicago Bears"
  abbreviation  String    @unique  // e.g., "CHI"
  city          String
  conference    String    // AFC, NFC
  division      String    // North, South, East, West
  record        String?   // e.g., "4-13"
  draftOrder    Int?      // Overall pick position (round 1)

  // Needs by position (1=critical, 2=moderate, 3=depth)
  needs         String    // JSON: { "QB": 1, "WR": 2, "CB": 1, ... }

  // Cap space
  capSpace      String?   // e.g., "$45.2M"
  keyFAs        String?   // JSON: notable free agents lost/gained

  picks         DraftPick[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

/// A complete mock draft
model MockDraft {
  id            String    @id @default(uuid())
  slug          String    @unique
  title         String
  description   String?
  version       Int       @default(1)
  rounds        Int       @default(7)   // How many rounds
  totalPicks    Int       @default(259)
  generatedBy   String    @default("SYSTEM") // SYSTEM, user ID, etc.
  isPublished   Boolean   @default(false)
  isFeatured    Boolean   @default(false)

  picks         DraftPick[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([isPublished, createdAt])
}

/// Individual pick in a mock draft
model DraftPick {
  id            String    @id @default(uuid())

  mockDraftId   String
  mockDraft     MockDraft @relation(fields: [mockDraftId], references: [id], onDelete: Cascade)

  prospectId    String
  prospect      DraftProspect @relation(fields: [prospectId], references: [id])

  nflTeamId     String?
  nflTeam       NFLTeamNeeds? @relation(fields: [nflTeamId], references: [id])

  // Pick details
  overall       Int       // Overall pick number
  round         Int
  pickInRound   Int
  teamName      String    // Denormalized for display
  isTradeUp     Boolean   @default(false)
  tradeNote     String?

  // Analysis
  fitScore      Int?      // 0-100 how well prospect fits team needs
  rationale     String?   // Why this pick makes sense

  createdAt     DateTime  @default(now())

  @@unique([mockDraftId, overall])
  @@index([prospectId])
  @@index([mockDraftId, round])
}

/// Sports pick data for pick'em contests
model SportsPick {
  id            String    @id @default(uuid())
  sport         String    // NFL, NBA, CFB, etc.
  eventDate     DateTime
  homeTeam      String
  awayTeam      String
  league        String?
  status        String    @default("UPCOMING")  // UPCOMING, LIVE, FINAL
  homeScore     Int?
  awayScore     Int?
  spread        Float?
  overUnder     Float?
  result        String?   // HOME, AWAY, PUSH
  metadata      String?   // JSON: odds, props, etc.

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([sport, eventDate])
  @@index([status])
}
